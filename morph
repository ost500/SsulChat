
# -*- coding: utf-8 -*-

# encoding=utf8

import time
import sys
import datetime
import MySQLdb

reload(sys)
sys.setdefaultencoding('utf8')

from konlpy.tag import Twitter
twitter = Twitter()


print(sys.argv)
parameter = sys.argv


# Open database connection
db = MySQLdb.connect(parameter[1],parameter[2],parameter[3],parameter[4] )

while(1):

    # prepare a cursor object using cursor() method
    cursor = db.cursor()

    # execute SQL query using execute() method.
    cursor.execute("SELECT * FROM chattings WHERE morphed=0 LIMIT 100")


    results = cursor.fetchall()
    for row in results:

        try:

            chatting_id = row[0]
            message = row[1]
            channel_id = row[4]

            # ssul_id 검색
            cursor.execute("SELECT * FROM channels WHERE id="+str(channel_id))
            channel = cursor.fetchone()
            ssul_id = str(channel[2])


            print("id : " + str(chatting_id) + " message : " +message)

            morphs = twitter.nouns(message)

            for morphed_message in morphs:

                query = "SELECT * FROM morphs WHERE morph='" + str(morphed_message) + "'"
                alreadyExistCursor = db.cursor()
                alreadyExistCursor.execute(query)

                alreadyExist = alreadyExistCursor.fetchone()

                if alreadyExist == None:
                    sql = "INSERT INTO morphs(ssul_id, morph, created_at, updated_at) VALUES ("+ssul_id+", '"+ morphed_message +"','"+datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S") +"','"+datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")+"')"


                    cursor.execute(sql)



                else:
                    sql = "UPDATE morphs SET count = count + 1 WHERE id = '%d'" % (alreadyExist[0])

                    cursor.execute(sql)

            sql = "UPDATE chattings SET morphed = 1 WHERE id = '%d'" % (chatting_id)

            cursor.execute(sql)


            db.commit()

        except:
            db.rollback()

    time.sleep(5)

# disconnect from server
db.close()